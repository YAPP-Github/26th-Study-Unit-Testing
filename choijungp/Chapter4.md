# 4장. 좋은 단위 테스트의 네 가지 핵심 기둥

## 4.1 좋은 단위 테스트의 네 가지 핵심 기둥 깊이 파고들기

좋은 단위 테스트는 다음과 같은 특징을 갖고 있다.
- 회귀로부터의 보호
- 리팩토링에 대한 저항성
- 빠른 피드백
- 유지보수성

<br>

### **회귀로부터의 보호**

**회귀란 ?**
- 기존 기능이 신규 코드 추가나 수정으로 인해 망가지는 버그이다.
- 기능이 많아질수록 회귀 발생 위험도 커진다.
- 코드는 자산이 아니라 부채 → 즉, 클수록 관리하기 어렵고 버그 위험이 증가하게 된다.

좋은 단위 테스트는 새로운 코드가 기존 기능을 망가뜨리지 않도록 지켜주는 역할을 해야 한다.         

회귀 방지를 잘하는 테스트는 다음 3가지를 고려해야 한다.   
- 테스트가 실행하는 코드의 양
    - 실행되는 코드의 양이 많을수록 회귀를 발견할 가능성이 높아진다. (단, 검증도 포함되어야 한다.)
- 해당 코드의 복잡도
- 도메인 상의 중요도

<br>

### 리팩터링에 대한 저항력
코드를 리팩터링하더라도 테스트가 실패하지 않고 견딜 수 있는 정도를 뜻한다.        

**거짓 양성 (false positive)**
- 기능은 잘 작동하지만 테스트가 실패하는 경우를 “거짓 양성”이라고 한다.
- 보통 코드를 리팩터링할 때 발생한다.
- 테스트가 리팩터링에 대한 저항력이라는 지표에서 얼마나 좋은 점수를 받을 수 있는지 평가하기 위해서는 그 테스트가 얼마나 자주 거짓 양성을 발생시키는지 봐야 한다.
- 거짓 양성이 적을수록 좋은 테스트다.

**그렇다면 거짓 양성이 왜 문제일까 ?**    
- 조기 경고 기능 상실 → 진짜 버그가 발생해도 무시하게 된다.
- 테스트 신뢰도 하락
- 리팩터링 위축 → 코드 개선이 어려워지고 기술 부채가 쌓이게 된다.

<br>

### 거짓 양성의 발생 이유
- 테스트가 구현 세부사항에 너무 의존할 때 발생한다.
- 테스트가 시스템의 외부 동작이 아닌 내부 구현 방식(알고리즘, 구조)에 집중할 때 발생한다.

이를 해결하는 방법으로는    
- 테스트를 구현 세부사항과 분리한다.
- 테스트는 SUT가 제공하는 최종 결과(외부에서 관찰 가능한 동작)만을 검증해야 한다.

---

## 4.2 첫 번째와 두 번째 속성 간의 본질적인 연관성
프로젝트가 시작된 직후에는 회귀 방지가 매우 중요하지만, 리팩터링 저항성의 필요성은 즉각적으로 나타나지 않는다.

### 테스트 정확도 극대화하기
코드의 정확성과 테스트 결과를 기준으로 할 때, 가능한 결과는 네 가지이다.       
테스트는 통과하거나 실패할 수 있으며, 기능 자체는 올바르거나 문제가 있을 수 있다.

- 참 음성 (true negative: TN)
    - 기능이 올바르게 작동하고 테스트가 통과할 때의 상황이 정확한 추론이다.
- 참 양성 (true positive: TP)
    - 기능에 문제가 있고 테스트가 실패하는 경우에도 정확한 추론이다.
- 거짓 음성 (false negative: FN)
    - 기능에 문제가 있지만 테스트가 오류를 잡아내지 못할 때의 상황이다. → 회귀 방지 능력이 좋은 테스트는 거짓 음성의 수를 최소화하는데 도움을 준다.
- 거짓 양성 (false positive: FP)
    - 기능에 아무 문제가 없지만 테스트가 실패하는 경우, 잘못된 경고 → 리팩토링에 대한 저항성이 도움을 주는 부분이다.
    - 프로젝트 초기에는 거짓 양성이 거짓 음성만큼 나쁘지 않지만 프로젝트가 성장함에 따라 거짓 양성은 테스트에 점점 더 큰 영향을 미친다.

회귀 방지 능력과 리팩토링에 대한 저항성은 테스트 정확도를 극대화하는 것을 목표로 한다.

정확도 지표는 다음 두 가지 요소로 구성된다.
- 버그가 존재함을 얼마나 잘 나타내는가 (거짓 음성의 부재 - 회귀 방지 능력의 영역)
- 버그가 존재하지 않음을 얼마나 잘 나타내는가 (거짓 양성의 부재 - 리팩토링 저항성의 영역)

```테스트 정확도 = 버그를 찾아내는 능력 / 거짓 경보의 획수```        
즉, 테스트 정확도는 신호 (버그를 찾아내는 능력)가 강하고, 잡음 (거짓 경보)이 적을수록 정확도가 높아진다.

---

## 4.3 빠른 피드백과 유지 보수성

**빠른 피드백**   
테스트가 빠르게 실행되면 피드백 루프를 단축할 수 있어, 코드가 잘못되자마자 테스트가 바로 버그를 경고해주고 해당 버그를 수정하는 비용을 줄일 수 있다.

<br>

**유지 보수성**     
유지 보수성 척도는 테스트의 유지 비용을 평가한다.

- 테스트를 이해하기 얼마나 어려운가 → 테스트 코드의 줄 수가 적을수록 더 읽기 쉬운 테스트가 된다.
- 테스트를 실행하기 얼마나 어려운가 → 프로세스 외부의 의존성과 함께 작동하는 경우, 해당 의존성을 유지하기 위해 시간을 들여야 한다.

---

## 4.4 이상적인 테스트
좋은 단위 테스트의 특징 네 가지
- 회귀 방지
- 리팩토링에 대한 저항성
- 빠른 피드백
- 유지 보수성

이 네 가지 속성은 곱셈처럼 결합되어 있다.

하지만 이상적인 테스트를 만드는 것은 불가능하다.     
- 회귀 방지, 리팩터링에 대한 저항성, 빠른 피드백이 서로 상충되기 때문이다.

<br>

**E2E 테스트**
- 거짓 양성에 강하기 때문에 리팩터링에 대한 저항성도 뛰어나다.
- 리팩토링이 올바르게 수행된다면 시스템의 외부 행동은 변하지 않으며 E2E 테스트에도 영향을 미치지 않는다.
- 특정한 구현 방식에 의존하지 않는다. 최종 사용자 관점에서 어떻게 동작하는 가만을 본다.
- 하지만 느리다는 단점이 있다.
    - 느린 테스트는 빠른 피드백을 얻기 어렵기 때문에 E2E 테스트에만 의존하는 시스템은 개발 속도가 느려질 수 밖에 없다.

<br>

**사소한 테스트**
- 빠른 피드백을 제공한다.
- 거짓 양성을 발생시킬 가능성이 낮기 때문에 리팩토링에 대한 저항력도 좋다.
- 하지만 코드 자체가 너무 단순하여 실수할 여지가 거의 없기 때문에 회귀 오류를 발견할 가능성이 거의 없다.

<br>

**취약한 테스트**
- 빠르게 실행된다.
- 회귀를 잡아낼 가능성이 높다.
- 하지만 수많은 거짓 양성을 발생시키는 경우가 있다. → 리팩토링을 견디지 못하고 기본 기능이 제대로 작동하고 있는지 여부와 상관없이 실패하게 된다.

즉, 회귀 방지, 리팩터링에 대한 저항성, 빠른 피드백은 서로 양립할 수 없다.         
세 가지 속성 중 두 가지를 극대화하는 테스트를 만드는 것은 비교적 쉽지만, 그렇게 하려면 나머지 한 가지 속성을 희생해야 한다.      

하지만 리팩토링에 대한 저항성은 양보할 수 없는 속성이다.       
네 번째 속성인 유지보수성은 첫 세 가지 속성과는 상관관계가 없다. (E2E 테스트는 예외)      

---

## 4.5 테스트 자동화 개념 탐색하기

테스트 피라미드는 테스트 내에서 서로 다른 유형의 테스트들 간의 특정 비율을 권장하는 개념이다.        

```단위 테스트 → 통합 테스트 → 엔드 투 엔드 테스트```

층이 넓을수록 테스트의 개수가 많다는 뜻이고,       
층의 높이는 이러한 테스트가 최종 사용자의 행동을 얼마나 잘 모방하는지를 측정하는 기준이다.

피라미드 상단에 위치한 테스트일수록 회귀 방지에 중점을 두며, 하단에 위치한 테스트일수록 빠른 피드백을 더 중시한다.

<br>

**블랙박스 테스트 vs 화이트박스 테스트**
- **블랙박스 테스트**는 시스템 내부 구조를 알지 못한 채 시스템의 기능을 검사하는 소프트웨어 테스트 방법
    - 명세서와 요구사항을 기반으로 하여 어떻게 작동하는지가 아닌 “무엇을 해야 하는지” 를 검증한다.
- **화이트박스 테스트**는 그 반대 개념으로, 내부 동작을 검증하는 테스트 방법
    - 소스 코드를 분석함으로써 외부 명세서에만 의존할 경우 놓칠 수 있는 많은 오류를 발견할 수 있다.
    - 하지만 특정 구현에 밀접하게 결합되는 경향이 있어 테스트가 쉽게 깨지며 많은 수의 거짓 양성을 발생시킨다. → 리팩터링에 대한 저항성이 부족한 경우가 발생한다.

|  | 회귀 방지 | 리팩터링에 대한 저항성 |
| --- | --- | --- |
| 화이트박스 테스트 | Good | Bad |
| 블랙박스 테스트 | Bad | Good |

기본적으로 테스트를 작성할 때에는 블랙박스 테스트를 선택하고, 테스트를 분석할 때는 화이트박스 방식을 사용하는 것이 좋다.

---

## 느낀점

이번 장을 통해서 좋은 테스트를 나타내는 네 가지 지표를 확인할 수 있었다.

네 가지 지표 중에 “리팩토링에 대한 저항성”은 포기할 수 없는 것이라고 말하는데 이것에 크게 공감했다.

저번 프로젝트에서 리팩토링에 대한 저항성을 전혀 지키지 못한 테스트를 진행한 적이 있어서 리팩토링 후에 테스트가 많이 실패했었다 ㅜㅜ

그때의 경험이 떠오르면서 이번 장을 통해 테스트 작성 시 주의해야 할 점들에 대해 다시 한번 깊이 생각해보게 되었다.   

이번 프로젝트에서는 변화에 유연한 테스트와 회귀 방지를 할 수 있는 테스트를 잘 설계해보고 싶다.
