# **7. 가치 있는 단위 테스트를 향한 리팩터링**

## **7. 1. 리팩터링할 코드를 식별하기**

모든 프로덕션 코드는 두 가지 기준에 따라 분류할 수 있다

- 코드 복잡도 또는 도메인 중요도
- 협력 객체(collaborator)의 수

### 복잡도와 도메인 중요도

**코드 복잡도** ? 코드 내 분기점의 수에 비례

cyclomatic complexity: 특정 프로그램이나 메서드 내에 존재하는 분기의 수 = **1 + (분기 지점의 수)**

== 하나의 메서드 내에서 진입 지점부터 종료 지점까지 존재할 수 있는 **독립적인 경로의 수**

== **100% 분기 커버리지를 달성하기 위해 필요한 테스트 수**

**도메인 중요도** ? 프로젝트의 문제 영역과 얼마나 밀접하게 관련되어 있는지

도메인 레이어에 있는 코드는 최종 사용자의 목표와 직접 연결되어 있기 때문에 도메인 중요도가 높음

→ 도메인 코드라고 해서 반드시 복잡할 필요는 없고, 복잡한 코드라고 해서 도메인 중요도가 반드시 높지 않음

### 협력 객체의 수

클래스나 메서드가 가진 협력 객체(collaborator)의 수

== 변경 가능하거나(mutable), 프로세스 외부에 존재하는(out-of-process) 의존성

- **프로세스 외부 의존성(out-of-process dependency)** 은 도메인 모델에서는 되도록 사용하지 않는 것이 좋음
- 정적 메서드를 통해 암묵적으로 의존하는 경우도 count에 포함됨
- **불변(immutable) 의존성**은 포함되지 않음

<img width="700" alt="스크린샷 2025-06-27 오후 7 05 55" src="https://github.com/user-attachments/assets/66d6cd08-dec0-4af8-8ee2-d9676abc38e7" />


### **Humble Object 패턴을 활용한 코드 분리**

- 복잡한 코드에서 핵심 로직을 분리
- 헥사고날 아키텍처(hexagonal architecture), 함수형 아키텍처(functional architecture)도 이 패턴을 따름
    - 헥사고날 아키텍처는 **비즈니스 로직**과 **프로세스 외부 의존성과의 통신**을 분리
        - 비즈니스 로직은 **도메인 레이어**가, 외부와의 통신은 **애플리케이션 서비스 레이어**가 담당
    - 함수형 아키텍처는 **모든 협력 객체와의 통신**을 비즈니스 로직에서 완전히 분리
        - 모든 의존성이 불변
- 단일 책임 원칙을 따르는 것으로도 해석 가능
    - **깊은 코드**: 복잡하거나 중요한 로직을 담고 있음
    - **넓은 코드**: 많은 협력 객체와 상호작용함
    
    → 둘 중에 하나의 특성만 가져야함! 깊으면서 넓으면 안됨
    
- **MVP(Model-View-Presenter)**
- **MVC(Model-View-Controller)**

→ 비즈니스 로직(Model), UI(View), 그리고 이 둘의 조율(Presenter 또는 Controller)을 분리 → Presenter나 Controller는 Humble Object의 역할

- **Domain-Driven Design**에서의 **Aggregate 패턴**

→ 클래스를 클러스터(aggregate)로 묶어 클래스 간 연결성을 줄임

## **7. 2. 가치 있는 단위 테스트를 위한 리팩터링**

**과도하게 복잡한 코드**를 **알고리즘**과 **컨트롤러**로 나누는 포괄적인 예시를 소개

- **도메인 모델은 외부 시스템과 직접 또는 간접적으로 어떤 방식으로든 연결되어서는 안된다**
- 프로세스 내부 의존성만 갖도록 리팩토링
    - 다른 도메인 클래스
    - 단순 값(value)

→ 우리는 도메인인 `User` 클래스만 테스트하면 된다. 나머지 분리된 코드는 **유틸리티 코드**이므로 테스트하는 의미가 없음

## 7. 3. **최적의 단위 테스트 커버리지 분석**

### **7. 3. 3. 전제 조건(Precondition)을 테스트해야 할까?**

- **도메인적으로 의미 있는 전제 조건은 테스트하자.**

ex. 직원 수는 음수가 될 수 없다 → 이는 `Company` 클래스의 불변 조건이며, 항상 만족되어야 하는 핵심 규칙이다. 그래서 테스트할 가치가 있다

## **7.4. 컨트롤러에서 조건 분기 로직 다루기**
